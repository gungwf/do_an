<div class="chat-window-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-content">
      <button class="btn-back" *ngIf="currentView === 'chat'" (click)="backToRooms()">
        <i class="bi bi-arrow-left"></i>
      </button>
      <h5 class="mb-0">
        <span *ngIf="currentView === 'rooms'">
          <i class="bi bi-chat-dots me-2"></i>Tin nh·∫Øn
        </span>
        <span *ngIf="currentView === 'chat' && selectedRoom">
          {{ getRoomName(selectedRoom) }}
          <small class="text-muted ms-2">
            ({{ getOtherParticipantRole(selectedRoom) }})
          </small>
        </span>
      </h5>
      <button class="btn-close-chat" (click)="close()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>

  <!-- Body -->
  <div class="chat-body">
    <!-- Danh s√°ch rooms -->
    <div *ngIf="currentView === 'rooms'" class="rooms-list">
      <div *ngIf="isLoading" class="text-center p-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <div *ngIf="!isLoading && rooms.length === 0" class="empty-state">
        <i class="bi bi-chat-left-text"></i>
        <p>Ch∆∞a c√≥ cu·ªôc h·ªôi tho·∫°i n√†o</p>
        <small class="text-muted">
          {{ userRole === 'PATIENT' ? 'Nh·∫•n "Li√™n h·ªá ngay" t·ª´ danh s√°ch b√°c sƒ© ƒë·ªÉ b·∫Øt ƒë·∫ßu chat' : 'B·ªánh nh√¢n s·∫Ω li√™n h·ªá v·ªõi b·∫°n khi c·∫ßn' }}
        </small>
      </div>

      <div class="room-item" *ngFor="let room of rooms" (click)="openRoom(room)">
        <div class="room-avatar">
          <i class="bi" [class.bi-person-circle]="getOtherParticipantRole(room) === 'PATIENT'"
                        [class.bi-hospital]="getOtherParticipantRole(room) === 'DOCTOR'"></i>
        </div>
        <div class="room-info">
          <div class="room-name">
            {{ getRoomName(room) }}
            <span class="role-badge" [class.doctor]="getOtherParticipantRole(room) === 'DOCTOR'"
                                    [class.patient]="getOtherParticipantRole(room) === 'PATIENT'">
              {{ getOtherParticipantRole(room) }}
            </span>
          </div>
          <div class="room-last-message text-muted" *ngIf="room.lastMessage">
            {{ room.lastMessage.content }}
          </div>
        </div>
        <div class="room-meta">
          <div class="room-time text-muted" *ngIf="room.lastMessage">
            {{ formatTime(room.lastMessage.createdAt) }}
          </div>
          <span class="unread-count" *ngIf="room.unreadCount && room.unreadCount > 0">
            {{ room.unreadCount }}
          </span>
        </div>
      </div>
    </div>

    <!-- C·ª≠a s·ªï chat -->
    <div *ngIf="currentView === 'chat' && selectedRoom" class="chat-view">
      <!-- Messages container -->
      <div class="messages-container" #messagesContainer>
        <div class="messages-container" #messagesContainer>
          <div *ngIf="messages.length === 0" class="empty-messages">
            <i class="bi bi-chat-square-dots"></i>
            <p>B·∫Øt ƒë·∫ßu cu·ªôc h·ªôi tho·∫°i</p>
          </div>

          <div
            class="message"
            *ngFor="let message of messages"
            [class.my-message]="isMyMessage(message)"
            [class.other-message]="!isMyMessage(message)">
            
            <div class="message-content">
              <div class="sender-name" *ngIf="!isMyMessage(message)">
                {{ getSenderName(message.senderId, message) }}
              </div>
              <div class="message-bubble">
                {{ message.content }}
              </div>
              <div class="message-time">
                {{ formatTime(message.createdAt) }}
              </div>
            </div>
          </div>

          <!-- üî• ANCHOR ‚Äì QUAN TR·ªåNG -->
          <div #bottomAnchor></div>
        </div>

        <div *ngIf="messages.length === 0" class="empty-messages">
          <i class="bi bi-chat-square-dots"></i>
          <p>B·∫Øt ƒë·∫ßu cu·ªôc h·ªôi tho·∫°i</p>
        </div>

        <div class="message" *ngFor="let message of messages" 
             [class.my-message]="isMyMessage(message)"
             [class.other-message]="!isMyMessage(message)"
             [@messageAnim]>
          <div class="message-content">
            <div class="sender-name" *ngIf="!isMyMessage(message)">
              {{ getSenderName(message.senderId, message) }}
            </div>
            <div class="message-bubble">
              {{ message.content }}
            </div>
            <div class="message-time">
              {{ formatTime(message.createdAt) }}
              <i class="bi bi-check2-all ms-1" *ngIf="isMyMessage(message) && message.read"></i>
              <i class="bi bi-check2 ms-1" *ngIf="isMyMessage(message) && message.delivered && !message.read"></i>
            </div>
          </div>
        </div>
        <!-- Typing indicator -->
        <div class="typing-indicator" *ngIf="isTyping">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <span class="typing-text">ƒêang nh·∫≠p...</span>
        </div>
      </div>

      <!-- Input area -->
      <div class="input-area">
        <div class="input-wrapper">
          <input 
            type="text" 
            class="form-control message-input" 
            placeholder="Nh·∫≠p tin nh·∫Øn..."
            [(ngModel)]="newMessage"
            (input)="onInputChange()"
            (keypress)="onKeyPress($event)"
            [disabled]="isSending">
          <button 
            class="btn btn-primary btn-send" 
            (click)="sendMessage()"
            [disabled]="!newMessage.trim() || isSending">
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
