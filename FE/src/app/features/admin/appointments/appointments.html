<div class="admin-page">
  <!-- HEADER -->
  <div class="page-header mb-4">
    <div class="header-content">
      <div class="header-icon">
        <i class="bi bi-calendar-check-fill"></i>
      </div>
      <div class="header-text">
        <h2 class="page-title">Quản lý Cuộc hẹn</h2>
        <p class="page-subtitle">Theo dõi, tìm kiếm và thao tác với các cuộc hẹn của hệ thống</p>
      </div>
    </div>
  </div>

  <!-- FILTER CARD -->
  <div class="filter-card mb-4">
    <form [formGroup]="searchForm">
      <div class="filter-header">
        <i class="bi bi-funnel-fill"></i>
        <span>Bộ lọc tìm kiếm</span>
      </div>
      <div class="filter-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-building"></i>Chi nhánh</label>
            <select class="form-select" formControlName="branchId" (change)="onBranchChange()">
              <option value="">Tất cả chi nhánh</option>
              @for (branch of branches; track branch.id) {
                <option [value]="branch.id">{{ branch.branchName }}</option>
              }
            </select>
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-person-badge"></i>Bác sĩ</label>
            <select class="form-select" formControlName="doctorId" [disabled]="isLoadingDoctors">
              @if (isLoadingDoctors) {
                <option value="">Đang tải bác sĩ...</option>
              } @else if (searchForm.get('branchId')?.value) {
                <option value="">Tất cả (thuộc chi nhánh)</option>
              } @else {
                <option value="">Tất cả bác sĩ (toàn hệ thống)</option>
              }
              @for (doctor of filteredDoctors; track doctor.id) {
                <option [value]="doctor.id">{{ doctor.fullName }}</option>
              }
            </select>
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-flag-fill"></i>Trạng thái</label>
            <select class="form-select" formControlName="status">
              <option value="">Tất cả</option>
              <option value="PENDING_PAYMENT">Chờ thanh toán</option>
              <option value="CONFIRMED">Đã xác nhận</option>
              <option value="COMPLETED">Đã hoàn thành</option>
              <option value="CANCELED">Đã hủy</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-person"></i>Tên bệnh nhân</label>
            <input type="text" class="form-control" formControlName="patientName" placeholder="Nhập tên bệnh nhân..." />
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-person-badge"></i>Tên bác sĩ</label>
            <input type="text" class="form-control" formControlName="doctorName" placeholder="Nhập tên bác sĩ (hoặc chọn ở trên)" />
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-calendar-date"></i>Từ ngày</label>
            <input type="date" class="form-control" formControlName="startTime" />
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-calendar-date"></i>Đến ngày</label>
            <input type="date" class="form-control" formControlName="endTime" />
          </div>
        </div>
      </div>
      <div class="filter-footer">
        <button type="button" class="btn-filter primary" (click)="applyFilters()">
          <i class="bi bi-search"></i>Tìm kiếm
        </button>
        <button type="button" class="btn-filter secondary" (click)="resetSearch()">
          <i class="bi bi-x-circle"></i>Xóa bộ lọc
        </button>
      </div>
    </form>
  </div>

  <!-- TABLE CARD -->
  <div class="results-card">
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner-container">
        <div class="spinner-border" role="status"></div>
        <p>Đang tải dữ liệu...</p>
      </div>
    </div>
    <div *ngIf="!isLoading">
      <div class="table-container">
        <table class="appointments-table">
          <thead>
            <tr>
              <th>Bệnh nhân</th>
              <th>Bác sĩ</th>
              <th>Chi nhánh</th>
              <th>Thời gian hẹn</th>
              <th>Trạng thái</th>
              <th class="col-actions">Hành động</th>
            </tr>
          </thead>
          <tbody>
            @for (appt of appointments; track appt.id) {
              <tr>
                <td>{{ appt.patient.fullName || 'N/A' }}</td>
                <td>{{ appt.doctor.fullName || 'N/A' }}</td>
                <td>{{ appt.branch.branchName || 'N/A' }}</td>
                <td>{{ appt.appointmentTime | date:'dd/MM/yyyy HH:mm' }}</td>
                <td>
                  @switch (appt.status) {
                    @case ('PENDING_PAYMENT') { <span class="badge bg-warning text-dark">Chờ thanh toán</span> }
                    @case ('CONFIRMED') { <span class="badge bg-primary">Đã xác nhận</span> }
                    @case ('COMPLETED') { <span class="badge bg-success">Hoàn thành</span> }
                    @case ('CANCELED') { <span class="badge bg-danger">Đã hủy</span> }
                    @default { <span class="badge bg-secondary">{{ appt.status }}</span> }
                  }
                </td>
                <td class="col-actions">
                  <button class="btn-action view" title="Xem chi tiết">
                    <i class="bi bi-eye"></i> Xem
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  Chưa có dữ liệu
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <!-- Pagination -->
      <div class="pagination-wrapper" *ngIf="totalPages > 1">
        <div class="pagination-info">
          <i class="bi bi-info-circle"></i>
          Trang <strong>{{ currentPage + 1 }}</strong> / <strong>{{ totalPages }}</strong>
          <span class="separator">•</span>
          Tổng <strong>{{ totalElements }}</strong> cuộc hẹn
        </div>
        <div class="pagination-controls">
          <button class="btn-page" [disabled]="currentPage === 0" (click)="onPageChange(currentPage - 1)" title="Trang trước">
            <i class="bi bi-chevron-left"></i> Trước
          </button>
          <ng-container *ngFor="let page of getPageNumbers()">
            <button class="btn-page" [class.active]="page === currentPage" (click)="onPageChange(page)">
              {{ page + 1 }}
            </button>
          </ng-container>
          <button class="btn-page" [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(currentPage + 1)" title="Trang sau">
            Sau <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>