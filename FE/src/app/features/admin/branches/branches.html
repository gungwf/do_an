<div class="admin-page">
  <div class="page-header mb-4">
    <h2 class="page-title">Quản lý Chi nhánh</h2>
  </div>

  <div class="mb-3">
    @if (authService.isAdmin()) {
      <button class="btn btn-primary" (click)="openBranchModal(null)">
        <i class="bi bi-plus-circle me-2"></i>Thêm chi nhánh
      </button>
    }
  </div>

  <div class="card">
    <div class="card-body">
      @if (isLoading) {
        <div class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      } @else {
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th class="col-id">ID</th>
                <th>Tên chi nhánh</th>
                <th>Địa chỉ</th>
                <th>Số điện thoại</th>
                <th>Trạng thái</th>
                <th class="col-actions">Hành động</th>
              </tr>
            </thead>
            <tbody>
              @for (branch of branches; track branch.id) {
                <tr>
                  <td class="col-id text-truncate" title="{{ branch.id }}">{{ branch.id }}</td>
                  <td>{{ branch.branchName }}</td>
                  <td>{{ branch.address }}</td>
                  <td>{{ branch.phoneNumber }}</td>
                  
                  <td class="col-actions text-nowrap">
                    <span
                      class="status-icon"
                      [class.active]="branch.active === true"
                      [class.inactive]="branch.active === false"
                      [class.clickable]="authService.isAdmin()"
                      (click)="authService.isAdmin() && toggleBranchStatus(branch)"
                      [title]="authService.isAdmin() ? 'Click để đổi trạng thái' : (branch.active ? 'Hoạt động' : 'Không hoạt động')"
                    >
                      @if (branch.active === true) {
                        <i class="bi bi-check-circle-fill text-success"></i>
                      } @else {
                        <i class="bi bi-x-circle-fill text-danger"></i>
                      }
                    </span>
                  </td>
                  
                  <td>
                    <button
                      class="btn btn-sm btn-outline-info me-2"
                      (click)="openDetailModal(branch)"
                      title="Xem chi tiết"
                    >
                      <i class="bi bi-eye"></i>
                    </button>
                    
                    @if (authService.isAdmin()) {
                      <button 
                        class="btn btn-sm btn-outline-primary me-2" 
                        title="Sửa"
                        (click)="openBranchModal(branch)">
                        <i class="bi bi-pencil"></i>
                      </button>
                    }
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    Chưa có dữ liệu
                  </td>
                </tr>
              }
            </tbody>
          </table>
          
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
              Hiển thị {{ branches.length }} kết quả
            </div>
          </div>

        </div>
      }
    </div>
  </div>
</div>

@if (showBranchModal) {
  <div class="modal fade show" style="display: block" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ isEditMode ? 'Cập nhật Chi nhánh' : 'Thêm Chi nhánh' }}
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeBranchModal()"
          ></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="branchForm" (ngSubmit)="onSubmitBranch()">
            <div class="mb-3">
              <label class="form-label">Tên chi nhánh *</label>
              <input
                type="text"
                class="form-control"
                formControlName="branchName"
                [class.is-invalid]="branchForm.get('branchName')?.invalid && branchForm.get('branchName')?.touched"
              />
              @if (branchForm.get('branchName')?.invalid && branchForm.get('branchName')?.touched) {
                <div class="invalid-feedback">
                  Vui lòng nhập tên chi nhánh
                </div>
              }
            </div>

            <div class="mb-3">
              <label class="form-label">Địa chỉ *</label>
              <input
                type="text"
                class="form-control"
                formControlName="address"
                [class.is-invalid]="branchForm.get('address')?.invalid && branchForm.get('address')?.touched"
              />
              @if (branchForm.get('address')?.invalid && branchForm.get('address')?.touched) {
                <div class="invalid-feedback">
                  Vui lòng nhập địa chỉ
                </div>
              }
            </div>

            <div class="mb-3">
              <label class="form-label">Số điện thoại *</label>
              <input
                type="text"
                class="form-control"
                formControlName="phoneNumber"
                [class.is-invalid]="branchForm.get('phoneNumber')?.invalid && branchForm.get('phoneNumber')?.touched"
              />
              @if (branchForm.get('phoneNumber')?.invalid && branchForm.get('phoneNumber')?.touched) {
                <div class="invalid-feedback">
                  Vui lòng nhập số điện thoại
                </div>
              }
            </div>
            
            @if (isEditMode) {
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="activeCheck" formControlName="active">
                <label class="form-check-label" for="activeCheck">Đang hoạt động</label>
              </div>
            }
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeBranchModal()">
            Đóng
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="onSubmitBranch()"
            [disabled]="branchForm.invalid || isSubmitting"
          >
            @if(isSubmitting) {
              <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
            } @else {
              <span>Lưu</span>
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
}

@if (showDetailModal && selectedBranch) {
  <div class="modal fade show" style="display: block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết chi nhánh</h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeDetailModal()"
          ></button>
        </div>
        <div class="modal-body">
          @if (isLoadingDetail) {
            <div class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          } @else {
            <div class="row g-3">
              <div class="col-md-12">
                <strong>ID:</strong>
                <p>{{ selectedBranch.id }}</p>
              </div>
              <div class="col-md-6">
                <strong>Tên chi nhánh:</strong>
                <p>{{ selectedBranch.branchName }}</p>
              </div>
              <div class="col-md-6">
                <strong>Số điện thoại:</strong>
                <p>{{ selectedBranch.phoneNumber }}</p>
              </div>
              <div class="col-md-12">
                <strong>Địa chỉ:</strong>
                <p>{{ selectedBranch.address }}</p>
              </div>
              <div class="col-md-6">
                <strong>Trạng thái:</strong>
                <p>
                  @if (selectedBranch.active === true) {
                    <span class="badge bg-success">Hoạt động</span>
                  } @else {
                    <span class="badge bg-danger">Không hoạt động</span>
                  }
                </p>
              </div>
              <div class="col-md-6">
                <strong>Ngày tạo:</strong>
                <p>{{ selectedBranch.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
              </div>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">
            Đóng
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
}