<div class="admin-page">
  <!-- HEADER ĐẸP -->
  <div class="page-header mb-4">
    <div class="header-content">
      <div class="header-icon">
        <i class="bi bi-people-fill"></i>
      </div>
      <div class="header-text">
        <h2 class="page-title">Quản lý Người dùng</h2>
        <p class="page-subtitle">Theo dõi, tìm kiếm và thao tác với tài khoản bệnh nhân, bác sĩ, nhân viên</p>
      </div>
    </div>
    <button class="btn-reload" (click)="onSearch()">
      <i class="bi bi-arrow-clockwise"></i>
      Tải lại
    </button>
  </div>

  <!-- Tabs -->
<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link" [class.active]="activeTab === 'patients'" (click)="onTabChange('patients')" type="button">
      Bệnh nhân
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" [class.active]="activeTab === 'staff'" (click)="onTabChange('staff')" type="button">
      Nhân viên
    </button>
  </li>
</ul>

<!-- Staff Type Dropdown -->
<div *ngIf="activeTab === 'staff'" class="mb-3">
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" [class.active]="activeStaffType === 'doctors'" (click)="onStaffTypeChange('doctors')">
      Bác sĩ
    </button>
    <button type="button" class="btn btn-outline-primary" [class.active]="activeStaffType === 'clinic-staff'" (click)="onStaffTypeChange('clinic-staff')">
      Nhân viên phòng khám
    </button>
  </div>
</div>

  <!-- Search Form -->
  <div class="filter-card mb-4" *ngIf="activeTab === 'patients' || (activeTab === 'staff' && activeStaffType)">
    <form [formGroup]="searchForm">
      <div class="filter-header">
        <i class="bi bi-funnel-fill"></i>
        <span>Bộ lọc tìm kiếm</span>
      </div>
      <div class="filter-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-person"></i>Họ tên</label>
            <input type="text" class="form-control" formControlName="fullName" placeholder="Nhập họ tên" />
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-envelope"></i>Email</label>
            <input type="text" class="form-control" formControlName="email" placeholder="Nhập email" />
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-phone"></i>Số điện thoại</label>
            <input type="text" class="form-control" formControlName="phoneNumber" placeholder="Nhập số điện thoại" />
          </div>
          <div class="col-md-3">
            <label class="filter-label"><i class="bi bi-flag-fill"></i>Trạng thái</label>
            <select class="form-select" formControlName="active">
              <option value="">Tất cả</option>
              <option value="true">Hoạt động</option>
              <option value="false">Không hoạt động</option>
            </select>
          </div>
          <div *ngIf="activeTab === 'staff'" class="col-md-3">
            <label class="filter-label"><i class="bi bi-building"></i>Chi nhánh</label>
            <select class="form-select" formControlName="branchId">
              <option value="">Tất cả</option>
              <option *ngFor="let branch of branches" [value]="branch.id">{{ branch.branchName || branch.name }}</option>
            </select>
          </div>
          <div *ngIf="activeTab === 'staff' && activeStaffType === 'doctors'" class="col-md-3">
            <label class="filter-label"><i class="bi bi-heart-pulse"></i>Chuyên khoa</label>
            <input type="text" class="form-control" formControlName="specialty" placeholder="Nhập chuyên khoa" />
          </div>
        </div>
      </div>
      <div class="filter-footer">
        <button type="button" class="btn-filter primary" (click)="onSearch()">
          <i class="bi bi-search"></i>Tìm kiếm
        </button>
        <button type="button" class="btn-filter secondary" (click)="resetSearch()">
          <i class="bi bi-x-circle"></i>Xóa bộ lọc
        </button>
      </div>
    </form>
  </div>

  <!-- Action Buttons -->
  <div class="mb-3">
  <button
    *ngIf="activeTab === 'patients'"
    type="button"
    class="btn-filter primary"
    (click)="openPatientModal()"
  >
    <i class="bi bi-plus-circle"></i> Thêm bệnh nhân
  </button>
  <button
    *ngIf="activeTab === 'staff' && activeStaffType === 'doctors'"
    type="button"
    class="btn-filter primary"
    (click)="openStaffModal('doctors')"
  >
    <i class="bi bi-plus-circle"></i> Thêm bác sĩ
  </button>
  <button
    *ngIf="activeTab === 'staff' && activeStaffType === 'clinic-staff'"
    type="button"
    class="btn-filter primary"
    (click)="openStaffModal('clinic-staff')"
  >
    <i class="bi bi-plus-circle"></i> Thêm nhân viên phòng khám
  </button>
  </div>

  <!-- Table Card -->
  <div class="results-card">
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner-container">
        <div class="spinner-border" role="status"></div>
        <p>Đang tải dữ liệu...</p>
      </div>
    </div>

    <!-- Patients Table -->
    <div *ngIf="!isLoading && activeTab === 'patients'" class="table-container">
      <table class="appointments-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Họ tên</th>
            <th>Email</th>
            <th>Số điện thoại</th>
            <th>Trạng thái</th>
            <th class="text-center">Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of patients">
            <td>{{ user.id }}</td>
            <td>{{ user.fullName }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.phoneNumber }}</td>
            <td>
              <span [ngSwitch]="user.active">
                <span *ngSwitchCase="true" class="badge bg-success">
                  <i class="bi bi-check-circle-fill"></i> Hoạt động
                </span>
                <span *ngSwitchCase="false" class="badge bg-danger">
                  <i class="bi bi-x-circle-fill"></i> Không hoạt động
                </span>
              </span>
            </td>
            <td class="actions-cell text-center">
              <div class="action-buttons">
                <button class="btn-action view" (click)="openDetailModal(user.id)" title="Xem chi tiết">
                  <i class="bi bi-eye"></i>
                  Xem
                </button>
                <button class="btn-action edit" title="Sửa">
                  <i class="bi bi-pencil"></i>
                  Sửa
                </button>
                <button class="btn-action delete" (click)="deleteUser(user.id)" title="Xóa">
                  <i class="bi bi-trash"></i>
                  Xóa
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="patients.length === 0">
            <td colspan="6" class="text-center text-muted py-4">Chưa có dữ liệu</td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination -->
      <div class="pagination-wrapper" *ngIf="totalPages > 0">
        <div class="pagination-info">
          <i class="bi bi-info-circle"></i>
          Trang <strong>{{ currentPage + 1 }}</strong> / <strong>{{ totalPages }}</strong>
          <span class="separator">•</span>
          Tổng <strong>{{ totalElements }}</strong> bệnh nhân
        </div>
        <div class="pagination-controls">
          <button class="btn-page" [disabled]="currentPage === 0" (click)="onPageChange(currentPage - 1)" title="Trang trước">
            <i class="bi bi-chevron-left"></i> Trước
          </button>
          <div class="page-number">{{ currentPage + 1 }} / {{ totalPages }}</div>
          <button class="btn-page" [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(currentPage + 1)" title="Trang sau">
            Sau <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Doctors Table -->
    <div *ngIf="!isLoading && activeTab === 'staff' && activeStaffType === 'doctors'" class="table-container">
      <table class="appointments-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Họ tên</th>
            <th>Email</th>
            <th>Số điện thoại</th>
            <th>Chi nhánh</th>
            <th>Chuyên khoa</th>
            <th>Chứng chỉ</th>
            <th>Trạng thái</th>
            <th class="text-center">Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of doctors">
            <td>{{ user.id }}</td>
            <td>{{ user.fullName }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.phoneNumber }}</td>
            <td>{{ getBranchName(user.branchId) }}</td>
            <td>{{ user.specialty || 'N/A' }}</td>
            <td>{{ user.certificate || 'N/A' }}</td>
            <td>
              <span [ngSwitch]="user.active">
                <span *ngSwitchCase="true" class="badge bg-success">
                  <i class="bi bi-check-circle-fill"></i> Hoạt động
                </span>
                <span *ngSwitchCase="false" class="badge bg-danger">
                  <i class="bi bi-x-circle-fill"></i> Không hoạt động
                </span>
              </span>
            </td>
            <td class="actions-cell text-center">
              <div class="action-buttons">
                <button class="btn-action view" (click)="openDetailModal(user.id)" title="Xem chi tiết">
                  <i class="bi bi-eye"></i>
                  Xem
                </button>
                <button class="btn-action edit" title="Sửa">
                  <i class="bi bi-pencil"></i>
                  Sửa
                </button>
                <button class="btn-action delete" (click)="deleteUser(user.id)" title="Xóa">
                  <i class="bi bi-trash"></i>
                  Xóa
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="doctors.length === 0">
            <td colspan="9" class="text-center text-muted py-4">Chưa có dữ liệu</td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination -->
      <div class="pagination-wrapper" *ngIf="totalPages > 0">
        <div class="pagination-info">
          <i class="bi bi-info-circle"></i>
          Trang <strong>{{ currentPage + 1 }}</strong> / <strong>{{ totalPages }}</strong>
          <span class="separator">•</span>
          Tổng <strong>{{ totalElements }}</strong> bác sĩ
        </div>
        <div class="pagination-controls">
          <button class="btn-page" [disabled]="currentPage === 0" (click)="onPageChange(currentPage - 1)" title="Trang trước">
            <i class="bi bi-chevron-left"></i> Trước
          </button>
          <div class="page-number">{{ currentPage + 1 }} / {{ totalPages }}</div>
          <button class="btn-page" [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(currentPage + 1)" title="Trang sau">
            Sau <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Clinic Staff Table -->
    <div *ngIf="!isLoading && activeTab === 'staff' && activeStaffType === 'clinic-staff'" class="table-container">
      <table class="appointments-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Họ tên</th>
            <th>Email</th>
            <th>Số điện thoại</th>
            <th>Chi nhánh</th>
            <th>Trạng thái</th>
            <th class="text-center">Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of clinicStaff">
            <td>{{ user.id }}</td>
            <td>{{ user.fullName }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.phoneNumber }}</td>
            <td>{{ getBranchName(user.branchId) }}</td>
            <td>
            <span [ngSwitch]="user.active">
              <span *ngSwitchCase="true" class="badge bg-success">
                <i class="bi bi-check-circle-fill"></i> Hoạt động
              </span>
              <span *ngSwitchCase="false" class="badge bg-danger">
                <i class="bi bi-x-circle-fill"></i> Không hoạt động
              </span>
            </span>
          </td>
            <td class="actions-cell text-center">
              <div class="action-buttons">
                <button class="btn-action view" (click)="openDetailModal(user.id)" title="Xem chi tiết">
                  <i class="bi bi-eye"></i>
                  Xem
                </button>
                <button class="btn-action edit" title="Sửa">
                  <i class="bi bi-pencil"></i>
                  Sửa
                </button>
                <button class="btn-action delete" (click)="deleteUser(user.id)" title="Xóa">
                  <i class="bi bi-trash"></i>
                  Xóa
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="clinicStaff.length === 0">
            <td colspan="7" class="text-center text-muted py-4">Chưa có dữ liệu</td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination -->
      <div class="pagination-wrapper" *ngIf="totalPages > 0">
        <div class="pagination-info">
          <i class="bi bi-info-circle"></i>
          Trang <strong>{{ currentPage + 1 }}</strong> / <strong>{{ totalPages }}</strong>
          <span class="separator">•</span>
          Tổng <strong>{{ totalElements }}</strong> nhân viên
        </div>
        <div class="pagination-controls">
          <button class="btn-page" [disabled]="currentPage === 0" (click)="onPageChange(currentPage - 1)" title="Trang trước">
            <i class="bi bi-chevron-left"></i> Trước
          </button>
          <div class="page-number">{{ currentPage + 1 }} / {{ totalPages }}</div>
          <button class="btn-page" [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(currentPage + 1)" title="Trang sau">
            Sau <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

<!-- Patient Modal -->
<div
  *ngIf="showPatientModal"
  class="modal fade show"
  style="display: block"
  tabindex="-1"
  role="dialog"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm Bệnh nhân</h5>
        <button
          type="button"
          class="btn-close"
          (click)="closePatientModal()"
        ></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="patientForm" (ngSubmit)="onSubmitPatient()">
          <div class="mb-3">
            <label class="form-label">Họ tên *</label>
            <input
              type="text"
              class="form-control"
              formControlName="fullName"
              [class.is-invalid]="patientForm.get('fullName')?.invalid && patientForm.get('fullName')?.touched"
            />
            <div
              *ngIf="patientForm.get('fullName')?.invalid && patientForm.get('fullName')?.touched"
              class="invalid-feedback"
            >
              Vui lòng nhập họ tên
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email *</label>
            <input
              type="email"
              class="form-control"
              formControlName="email"
              [class.is-invalid]="patientForm.get('email')?.invalid && patientForm.get('email')?.touched"
            />
            <div
              *ngIf="patientForm.get('email')?.invalid && patientForm.get('email')?.touched"
              class="invalid-feedback"
            >
              Vui lòng nhập email hợp lệ
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Mật khẩu *</label>
            <input
              type="password"
              class="form-control"
              formControlName="password"
              [class.is-invalid]="patientForm.get('password')?.invalid && patientForm.get('password')?.touched"
            />
            <div
              *ngIf="patientForm.get('password')?.invalid && patientForm.get('password')?.touched"
              class="invalid-feedback"
            >
              Mật khẩu phải có ít nhất 6 ký tự
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Số điện thoại *</label>
            <input
              type="text"
              class="form-control"
              formControlName="phoneNumber"
              [class.is-invalid]="patientForm.get('phoneNumber')?.invalid && patientForm.get('phoneNumber')?.touched"
            />
            <div
              *ngIf="patientForm.get('phoneNumber')?.invalid && patientForm.get('phoneNumber')?.touched"
              class="invalid-feedback"
            >
              Vui lòng nhập số điện thoại
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePatientModal()">
          Đóng
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onSubmitPatient()"
          [disabled]="patientForm.invalid"
        >
          Lưu
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showPatientModal" class="modal-backdrop fade show"></div>

<!-- Staff Modal -->
<div
  *ngIf="showStaffModal"
  class="modal fade show"
  style="display: block"
  tabindex="-1"
  role="dialog"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ staffForm.get('role')?.value === 'DOCTOR' ? 'Thêm Bác sĩ' : 'Thêm Nhân viên phòng khám' }}
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeStaffModal()"
        ></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="staffForm" (ngSubmit)="onSubmitStaff()">
          <div class="mb-3">
            <label class="form-label">Họ tên *</label>
            <input
              type="text"
              class="form-control"
              formControlName="fullName"
              [class.is-invalid]="staffForm.get('fullName')?.invalid && staffForm.get('fullName')?.touched"
            />
            <div
              *ngIf="staffForm.get('fullName')?.invalid && staffForm.get('fullName')?.touched"
              class="invalid-feedback"
            >
              Vui lòng nhập họ tên
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email *</label>
            <input
              type="email"
              class="form-control"
              formControlName="email"
              [class.is-invalid]="staffForm.get('email')?.invalid && staffForm.get('email')?.touched"
            />
            <div
              *ngIf="staffForm.get('email')?.invalid && staffForm.get('email')?.touched"
              class="invalid-feedback"
            >
              Vui lòng nhập email hợp lệ
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Mật khẩu *</label>
            <input
              type="password"
              class="form-control"
              formControlName="password"
              [class.is-invalid]="staffForm.get('password')?.invalid && staffForm.get('password')?.touched"
            />
            <div
              *ngIf="staffForm.get('password')?.invalid && staffForm.get('password')?.touched"
              class="invalid-feedback"
            >
              Mật khẩu phải có ít nhất 6 ký tự
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Số điện thoại *</label>
            <input
              type="text"
              class="form-control"
              formControlName="phoneNumber"
              [class.is-invalid]="staffForm.get('phoneNumber')?.invalid && staffForm.get('phoneNumber')?.touched"
            />
            <div
              *ngIf="staffForm.get('phoneNumber')?.invalid && staffForm.get('phoneNumber')?.touched"
              class="invalid-feedback"
            >
              Vui lòng nhập số điện thoại
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Chi nhánh *</label>
            <select
              class="form-select"
              formControlName="branchId"
              [class.is-invalid]="staffForm.get('branchId')?.invalid && staffForm.get('branchId')?.touched"
            >
              <option value="">Chọn chi nhánh</option>
              <option *ngFor="let branch of branches" [value]="branch.id">
                {{ branch.branchName || branch.name }}
              </option>
            </select>
            <div
              *ngIf="staffForm.get('branchId')?.invalid && staffForm.get('branchId')?.touched"
              class="invalid-feedback"
            >
              Vui lòng chọn chi nhánh
            </div>
          </div>
          <div *ngIf="staffForm.get('role')?.value === 'DOCTOR'" class="mb-3">
            <label class="form-label">Chuyên khoa</label>
            <input
              type="text"
              class="form-control"
              formControlName="specialty"
              placeholder="Vd: Tim mạch, Hô hấp..."
            />
          </div>
          <div *ngIf="staffForm.get('role')?.value === 'DOCTOR'" class="mb-3">
            <label class="form-label">Chứng chỉ</label>
            <input
              type="text"
              class="form-control"
              formControlName="certificate"
              placeholder="Vd: BS-12345..."
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeStaffModal()">
          Đóng
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onSubmitStaff()"
          [disabled]="staffForm.invalid"
        >
          Lưu
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showStaffModal" class="modal-backdrop fade show"></div>

<!-- Detail Modal -->
<div
  *ngIf="showDetailModal"
  class="modal fade show"
  style="display: block"
  tabindex="-1"
  role="dialog"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết người dùng</h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeDetailModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div *ngIf="isLoadingDetail" class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div *ngIf="!isLoadingDetail && selectedUser">
          <div class="row g-3">
            <div class="col-md-6">
              <strong>ID:</strong>
              <p>{{ selectedUser.id }}</p>
            </div>
            <div class="col-md-6">
              <strong>Họ tên:</strong>
              <p>{{ selectedUser.fullName }}</p>
            </div>
            <div class="col-md-6">
              <strong>Email:</strong>
              <p>{{ selectedUser.email }}</p>
            </div>
            <div class="col-md-6">
              <strong>Số điện thoại:</strong>
              <p>{{ selectedUser.phoneNumber || 'N/A' }}</p>
            </div>
            <div class="col-md-6">
              <strong>Trạng thái:</strong>
              <p>
                <span
                  *ngIf="selectedUser.isActive === true"
                  class="badge bg-success"
                >
                  Hoạt động
                </span>
                <span
                  *ngIf="selectedUser.isActive === false"
                  class="badge bg-danger"
                >
                  Không hoạt động
                </span>
              </p>
            </div>
            <div *ngIf="activeTab === 'staff'" class="col-md-6">
              <strong>Chi nhánh:</strong>
              <p>{{ getBranchName(selectedUser.branchId) }}</p>
            </div>
            <div
              *ngIf="activeTab === 'staff' && activeStaffType === 'doctors'"
              class="col-md-6"
            >
              <strong>Chuyên khoa:</strong>
              <p>{{ selectedUser.specialty || 'N/A' }}</p>
            </div>
            <div
              *ngIf="activeTab === 'staff' && activeStaffType === 'doctors'"
              class="col-md-6"
            >
              <strong>Chứng chỉ:</strong>
              <p>{{ selectedUser.certificate || selectedUser.degree || 'N/A' }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">
          Đóng
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showDetailModal" class="modal-backdrop fade show"></div>