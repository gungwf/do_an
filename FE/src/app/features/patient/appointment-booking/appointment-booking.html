<div class="container py-5">
  <h1 class="mb-4 text-primary fw-bold">Đặt Lịch Khám Bệnh</h1>

  <!-- 1. Thông tin bệnh nhân (Giữ nguyên) -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Thông tin bệnh nhân</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="bookingForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="patientName" class="form-label">Họ và tên bệnh nhân</label>
            <input type="text" id="patientName" class="form-control" formControlName="patientName">
          </div>
          <div class="col-md-6">
            <label for="reason" class="form-label">Lý do khám / Triệu chứng <span class="text-danger">*</span></label>
            <input type="text" id="reason" class="form-control" formControlName="reason" placeholder="Ví dụ: Đau đầu, chóng mặt..." [class.is-invalid]="bookingForm.get('reason')?.invalid && bookingForm.get('reason')?.touched">
             <div *ngIf="bookingForm.get('reason')?.invalid && bookingForm.get('reason')?.touched" class="invalid-feedback">
                Vui lòng nhập lý do khám.
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 2. Tìm kiếm bác sĩ (ĐÃ CẬP NHẬT) -->
  <div class="card shadow-sm mb-4">
    <div class="card-header">
      <h5 class="mb-0">Tìm kiếm bác sĩ</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="bookingForm">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="doctorNameFilter" class="form-label">Tìm theo tên bác sĩ</label>
            <input type="text" id="doctorNameFilter" class="form-control" formControlName="doctorNameFilter" placeholder="Nhập tên bác sĩ...">
          </div>
          <div class="col-md-4">
            <label for="branchFilter" class="form-label">Chọn chi nhánh</label>
            <select id="branchFilter" class="form-select" formControlName="branchFilter">
              <option value="">Tất cả chi nhánh</option>
              <option *ngFor="let branch of branches$ | async" [value]="branch.id">{{ branch.branchName }}</option>
            </select>
          </div>
          
          <!-- (ĐÃ SỬA) Thay input bằng select chuyên khoa -->
          <div class="col-md-4">
            <label for="specialtyFilter" class="form-label">Chọn chuyên khoa</label>
            <select id="specialtyFilter" class="form-select" formControlName="specialtyFilter">
              <option value="">Tất cả chuyên khoa</option>
              <!-- Lặp qua danh sách specialties$ -->
              <option *ngFor="let spec of specialties$ | async" [value]="spec.name">
                {{ spec.name }}
              </option>
            </select>
          </div>
          
        </div>
      </form>
    </div>
  </div>

  <!-- 3. Danh sách bác sĩ (Giữ nguyên) -->
  <div class="card shadow-sm">
    <div class="card-header">
      <h5 class="mb-0">Chọn bác sĩ</h5>
    </div>
    <div class="card-body">
      <div *ngIf="isLoading" class="text-center p-4">
        <!-- ... (Spinner tải bác sĩ) ... -->
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải danh sách bác sĩ...</p>
      </div>

      <div *ngIf="!isLoading">
        <div *ngIf="(filteredDoctors$ | async) as doctors; else noDoctors">
          <div *ngIf="doctors.length > 0; else noDoctors">
            <ul class="list-group list-group-flush">

              <!-- Bắt đầu vòng lặp bác sĩ -->
              <li *ngFor="let doctor of doctors"
                  class="list-group-item doctor-item"
                  [class.active]="selectedDoctor?.id === doctor.id"
                  (click)="selectDoctor(doctor)">

                <!-- Thông tin cơ bản của bác sĩ (Giữ nguyên) -->
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                  <div class="d-flex align-items-center mb-2 mb-md-0">
                    <i class="bi bi-person-circle fs-2 me-3 text-secondary"></i>
                    <div>
                      <h6 class="mb-0 fw-bold">{{ doctor.fullName }}</h6>
                      <small class="text-muted">
                        <!-- (QUAN TRỌNG) Chờ backend cập nhật API /users/doctors để trả về specialty -->
                        Chuyên khoa: {{ doctor.specialty || '...' }} | Giá khám: {{ (doctor.price || 300000) | currency:'VND':'đ' }}
                      </small>
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-primary mt-2 mt-md-0">
                    {{ selectedDoctor?.id === doctor.id ? 'Đang chọn' : 'Chọn' }}
                  </button>
                </div>

                <!-- Khối lịch hẹn (Giữ nguyên logic hiển thị) -->
                <div *ngIf="selectedDoctor?.id === doctor.id" class="schedule-container mt-4">

                  <!-- 1. Chọn ngày (Giữ nguyên) -->
                  <h6 class="fw-bold">Chọn ngày khám:</h6>
                  <div class="date-selector mb-3">
                    <button *ngFor="let day of calendarDays"
                            class="date-btn"
                            [class.active]="selectedDate === day.date"
                            (click)="$event.stopPropagation(); selectDate(day.date)">
                      <b>{{ day.dayOfWeek }}</b>
                      <span class="small">{{ day.label }}</span>
                    </button>
                  </div>

                  <!-- 2. Thông tin chi tiết & Chọn giờ (Giữ nguyên) -->
                  <div *ngIf="selectedDate">
                    <!-- Spinner tải giờ (Giữ nguyên) -->
                    <div *ngIf="isLoadingSlots" class="text-center p-3">
                      <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2 mb-0 small">Đang tải giờ trống...</p>
                    </div>

                    <div *ngIf="!isLoadingSlots">
                      <!-- Thông tin địa chỉ (Giữ nguyên) -->
                      <div class="schedule-details mb-3 p-3 bg-light rounded">
                        <div *ngIf="getBranchDetails(doctor.branchId) as branch">
                          <h6 class="fw-bold text-primary mb-2">{{ branch.branchName }}</h6>
                          <p class="mb-1 small">
                            <i class="bi bi-geo-alt-fill me-2"></i>
                            {{ branch.address || 'Không có thông tin địa chỉ.' }}
                          </p>
                        </div>
                        <p class="mb-1 small">
                          <i class="bi bi-person-badge-fill me-2"></i>
                          Chuyên khoa: {{ doctor.specialty || '...' }}
                        </p>
                        <p class="mb-0 small text-danger fw-bold">
                          <i class="bi bi-cash-coin me-2"></i>
                          Giá khám: {{ (doctor.price || 300000) | currency:'VND':'đ' }}
                        </p>
                      </div>

                      <!-- Danh sách giờ (Giữ nguyên) -->
                      <h6 class="fw-bold">Chọn giờ khám:</h6>
                      <div class="slot-container">
                        <!-- 
                          LƯU Ý: Code này giả định backend chỉ trả về giờ CÒN TRỐNG.
                          Để hiển thị "Hết chỗ", backend cần trả về TẤT CẢ giờ 
                          kèm trạng thái { time: '...', available: false }
                        -->
                        <div *ngIf="availableSlots.length > 0; else noSlots">
                          <button *ngFor="let time of availableSlots"
                                  class="slot-btn"
                                  [class.active]="selectedTime === time"
                                  (click)="$event.stopPropagation(); selectTime(time)">
                            {{ time | slice:0:5 }}
                          </button>
                        </div>
                        <ng-template #noSlots>
                          <p class="small text-muted">Không có ca trống cho ngày này.</p>
                        </ng-template>
                      </div>

                      <!-- Nút xác nhận (Giữ nguyên) -->
                      <hr class="my-4">
                      <button class="btn btn-success w-100"
                              [disabled]="!selectedTime || isLoadingSlots"
                              (click)="$event.stopPropagation(); openConfirmModal()"> <!-- Đổi hàm gọi sang openConfirmModal() -->
                        Xác nhận đặt lịch {{ selectedTime ? '(' + (selectedTime | slice:0:5) + ')' : '' }}
                      </button>
                    </div>
                  </div>
                </div> <!-- ===== KẾT THÚC KHỐI LỊCH HẸN ===== -->

              </li> <!-- Kết thúc vòng lặp bác sĩ -->
            </ul>
          </div>
        </div>
         <ng-template #noDoctors>
            <p class="text-center text-muted p-3">Không tìm thấy bác sĩ phù hợp.</p>
         </ng-template>
      </div>
    </div>
  </div>
</div>

<!-- ===== (MỚI) DIALOG TÓM TẮT ĐẶT LỊCH ===== -->
<div *ngIf="isConfirmModalOpen">
  <!-- Backdrop (lớp mờ) -->
  <div class="confirm-modal-backdrop" (click)="closeConfirmModal()"></div>

  <!-- Panel (thanh trượt bên phải) -->
  <div class="confirm-modal-panel">
    <div class="confirm-modal-header">
      <h4 class="fw-bold text-primary mb-0">Tóm tắt lịch khám</h4>
      <button type="button" class="btn-close" (click)="closeConfirmModal()"></button>
    </div>

    <!-- Nội dung tóm tắt -->
    <div class="confirm-modal-body" *ngIf="selectedDoctor && currentUser && selectedDate && selectedTime">
      
      <!-- Thông tin Bác sĩ -->
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-person-circle fs-1 me-3 text-secondary"></i>
        <div>
          <h5 class="mb-0 fw-bold">{{ selectedDoctor.fullName }}</h5>
          <p class="mb-0 text-muted">{{ selectedDoctor.specialty || 'Chuyên khoa...' }}</p>
        </div>
      </div>

      <hr>

      <!-- Thông tin Lịch hẹn -->
      <div class="d-flex flex-column gap-3">
        <div class="d-flex align-items-start">
          <i class="bi bi-calendar-event fs-5 me-3 text-primary"></i>
          <div class="confirm-item-value">
            <span class="fw-bold fs-5 text-danger">{{ selectedTime | slice:0:5 }}</span>
            <span>{{ selectedDate | date:'EEEE, dd/MM/yyyy':'':'vi-VN' }}</span>
          </div>
        </div>

        <div class="d-flex align-items-start" *ngIf="getBranchDetails(selectedDoctor.branchId) as branch">
          <i class="bi bi-hospital fs-5 me-3 text-primary"></i>
          <div class="confirm-item-value">
            <span class="fw-bold">{{ branch.branchName }}</span>
            <span>{{ branch.address }}</span>
          </div>
        </div>

        <div class="d-flex align-items-start">
          <i class="bi bi-person-fill fs-5 me-3 text-primary"></i>
          <div class="confirm-item-value">
            <span class="fw-bold">Bệnh nhân</span>
            <span>{{ currentUser.fullName }}</span>
          </div>
        </div>

        <div class="d-flex align-items-start">
          <i class="bi bi-card-text fs-5 me-3 text-primary"></i>
          <div class="confirm-item-value">
            <span class="fw-bold">Lý do khám</span>
            <span>{{ bookingForm.get('reason')?.value || 'Không có ghi chú' }}</span>
          </div>
        </div>

        <div class="d-flex align-items-start">
          <i class="bi bi-cash-coin fs-5 me-3 text-primary"></i>
          <div class="confirm-item-value">
            <span class="fw-bold">Giá khám</span>
            <span class="text-danger fw-bold fs-5">{{ (selectedDoctor.price || 300000) | currency:'VND':'đ' }}</span>
          </div>
        </div>
      </div>
      
    </div>

    <!-- Nút xác nhận cuối cùng -->
    <div class="confirm-modal-footer">
      <button class="btn btn-warning w-100 btn-lg" 
              [disabled]="isBooking" 
              (click)="onBookAppointment()">
        
        <span *ngIf="isBooking" class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
        <span *ngIf="isBooking">Đang xử lý...</span>
        
        <span *ngIf="!isBooking">
          <i class="bi bi-check-circle-fill me-2"></i>
          Xác nhận đặt khám
        </span>
      </button>
    </div>
  </div>
</div>

